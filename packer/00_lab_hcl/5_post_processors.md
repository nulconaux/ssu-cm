# Лабораторная работа 5: Постпроцессоры.
В этой лабораторной работе вы узнаете, как добавить постпроцессор в шаблон Packer HCL. Постпроцессоры запускаются после того, как образ построен построителем и предоставлен инициаторами. Постпроцессоры не являются обязательными, и их можно использовать для загрузки артефактов, переупаковки и т. Д.

Продолжительность: 30 минут

- Задача 1. Добавить постпроцессор Packer для написания манифеста всех созданных упаковщиком артефактов.
- Задача 2: проверка шаблона упаковщика.
- Задача 3. Создайте новое изображение с помощью Packer и отобразите список артефактов в виде манифеста.

### Задача 1. Добавьте постпроцессор Packer для написания манифеста всех созданных упаковщиком артефактов.
Постпроцессор манифеста записывает файл JSON со списком всех упаковщиков артефактов, созданных во время выполнения. Если ваш шаблон упаковщика включает несколько сборок, это поможет вам отслеживать, какие выходные артефакты (файлы, идентификаторы AMI, контейнеры докеров и т. Д.) Соответствуют каждой сборке.

### Шаг 1.1.1

Обновите блок `build` вашего файла` aws-ubuntu.pkr.hcl` следующим блоком Packer `post-processor`.

```hcl
build {
  sources = [
    "source.amazon-ebs.ubuntu"
  ]

  provisioner "shell" {
    inline = [
      "echo Installing Updates",
      "sudo apt-get update",
    ]
  }

  provisioner "file" {
    source      = "assets"
    destination = "/tmp/"
  }

  provisioner "shell" {
    inline = [
      "sudo sh /tmp/assets/setup-web.sh",
    ]
  }

  post-processor "manifest" {}

}
```

### Задача 2: Проверка шаблона упаковщика
Шаблоны упаковщика можно автоматически форматировать и проверять через командную строку упаковщика.

### Шаг 2.1.1

Отформатируйте и проверьте конфигурацию с помощью команд packer fmt и packer validate.

```shell
packer fmt aws-ubuntu.pkr.hcl
packer validate aws-ubuntu.pkr.hcl
```

### Задача 3. Создайте новый образ с помощью Packer.
Команда packer build используется для запуска процесса сборки образа для данного шаблона Packer.

### Шаг 3.1.1
Запустите `packer build` для шаблона` aws-ubuntu.pkr.hcl`.

```shell
packer build aws-ubuntu.pkr.hcl
```

Packer создаст файл манифеста, в котором перечислены все созданные им артефакты изображений.

```bash
ls -la
```

Это вернет список файлов в вашем рабочем каталоге. Убедитесь, что файл `packer-manifest.json` был создан.
```bash
...

-rw-r--r--   1 gabe  staff   419 May  5 07:47 packer-manifest.json

...
```

Просмотрите файл `packer-manifest.json` для получения подробной информации о созданных элементах.
```bash
cat packer-manifest.json
```

```bash
{
  "builds": [
    {
      "name": "ubuntu",
      "builder_type": "amazon-ebs",
      "build_time": *,
      "files": null,
      "artifact_id": "eu-central-1:ami-*,us-east-1:ami-*,us-west-2:ami-03b71c51298c1dc68",
      "packer_run_uuid": "*",
      "custom_data": null
    }
  ],
  "last_run_uuid": "*"
}%
```
